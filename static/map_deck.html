<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Marina di Pisa Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }

    /* Contr√¥les MapLibre √† droite (zoom + boussole) */
    .maplibregl-ctrl-top-right{
      margin:10px;
      display:flex; flex-direction:column; align-items:flex-end; gap:8px; z-index:7;
    }

    /* S√©lecteur de styles en haut √† droite (m√™me ligne que les contr√¥les) */
    #styleButtons{
      position:absolute;
      right:70px;
      top:10px;
      z-index:10;
      display:flex; gap:12px;
      padding:8px 10px;
      border-radius:14px;
      background:rgba(255,255,255,0.8);
      box-shadow:0 4px 16px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      align-items:center;
    }
    .style-card{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      padding:6px; border:none; background:transparent; cursor:pointer;
      border-radius:10px;
      box-shadow:0 0 0 2px rgba(0,0,0,0);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .style-card:hover{ transform:translateY(-1px); box-shadow:0 0 0 2px rgba(0,0,0,.10); }
    .style-card.active{ box-shadow:0 0 0 2px rgba(34,197,94,.9); background:rgba(255,255,255,0.55); }
    .style-chip{ width:60px; height:36px; border-radius:8px; box-shadow: inset 0 0 0 2px rgba(0,0,0,.06); }
    .chip-dark{  background:#9ca3af; }
    .chip-light{ background:#e5e7eb; }
    .chip-sat{   background:#22c55e; }
    .style-label{ font:13px/1.1 system-ui, sans-serif; color:#111827; font-weight:600; }

    /* Panneau de couches (gauche) */
    #panel{
      position:absolute; left:14px; top:10px; z-index:6;
      background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.12);
      padding:12px 14px; font:14px/1.4 system-ui, sans-serif; min-width:220px;
    }
    #panel h4{ margin:0 0 8px; font-weight:600; }
    #panel label{ display:flex; gap:8px; margin:6px 0; align-items:center; }

    /* Player & timeline (en bas) */
    #player {
      position: absolute; left: 14px; right: 14px; bottom: 14px;
      z-index: 6; background: #fff; border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.15); padding: 12px;
      display: grid; grid-template-columns: 1fr auto auto; gap: 12px;
      align-items: center; font: 14px/1.4 system-ui, sans-serif; border: 2px solid #54a2f5;
      pointer-events:auto;
    }
    #player.hidden { display: none; }

    #legendBar { display:flex; align-items:center; gap:10px; }
    #cbar { width:260px; height:12px; border-radius:6px; border:1px solid #e5e7eb; }
    #minLbl, #maxLbl { font-size:12px; color:#374151; }
    #minLbl .tag, #maxLbl .tag { color:#6b7280; font-weight:600; margin-right:6px; font-size:12px; }

    .controls { display:flex; align-items:center; gap:8px; }
    .btn{ width:40px; height:40px; border-radius:50%; background:#54a2f5; color:#fff; font-size:16px; border:none; box-shadow:0 3px 6px rgba(0,0,0,.2); cursor:pointer; transition:all .15s ease; }
    .btn:hover{ transform:scale(1.1); background:#54a2f5; }
    .right{ display:flex; gap:8px; align-items:center; }
    #nowLabel{ font-weight:600; color:#111827; }
    select{ padding:6px 12px; border-radius:8px; border:1px solid #54a2f5; background:#fff; color:#111827; font-weight:500; cursor:pointer; }
    select:focus{ outline:2px solid #54a2f5; }

    .timeline{ grid-column:1 / -1; display:flex; align-items:center; gap:12px; border-top:2px solid #54a2f5; padding-top:8px; }
    .label{ min-width:240px; color:#111827; font-size:13px; font-weight:500; }
    input[type=range]{ flex:1; appearance:none; height:6px; width: 1000px; border-radius:6px; background:linear-gradient(to right, #54a2f5, #54a2f5); outline:none; }
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#54a2f5; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.25); cursor:pointer; }

    #tooltip{ position:absolute; z-index:9; pointer-events:none; display:none; max-width:280px; padding:8px 10px; border-radius:8px; background:rgba(17,24,39,0.92); color:#fff; font:13px/1.35 system-ui, sans-serif; box-shadow:0 6px 18px rgba(0,0,0,.25); transform:translate(12px,12px); white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    #tooltip h5{ margin:0 0 6px; font-size:13px; font-weight:700; }
    #tooltip .muted{ color:#cbd5e1; font-size:12px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="tooltip"></div>

  <!-- Boutons de style -->
  <div id="styleButtons" role="group" aria-label="Fond de carte">
    <button class="style-card" data-style="Dark" aria-pressed="false">
      <span class="style-chip chip-dark"></span>
      <span class="style-label">Dark</span>
    </button>
    <button class="style-card active" data-style="Light" aria-pressed="true">
      <span class="style-chip chip-light"></span>
      <span class="style-label">Light</span>
    </button>
    <button class="style-card" data-style="Satellite" aria-pressed="false">
      <span class="style-chip chip-sat"></span>
      <span class="style-label">Satellite</span>
    </button>
  </div>

  <!-- Panneau couches -->
  <div id="panel">
    <h4>Livelli</h4>
    <label><input id="chkBuildings" type="checkbox" checked> Edifici</label>
    <label><input id="chkRoads" type="checkbox" checked> Rete stradale</label>
    <label><input id="chkTraffic" type="checkbox" checked> Traffico</label>
    <label><input id="chkNoise" type="checkbox"> Rumore</label>
  </div>

  <!-- Player -->
  <div id="player">
    <div id="legendBar">
      <span id="minLbl"></span>
      <canvas id="cbar"></canvas>
      <span id="maxLbl"></span>
    </div>

    <div class="controls">
      <button class="btn" id="btnPrev">‚èÆ</button>
      <button class="btn" id="btnPlay">‚ñ∂</button>
      <button class="btn" id="btnNext">‚è≠</button>
      <select id="speedSel" title="Vitesse lecture">
        <option value="1800" selected>0,5√ó</option>
        <option value="1200">0,75√ó</option>
        <option value="800">1√ó</option>
        <option value="500">1,5√ó</option>
      </select>
    </div>

    <div class="right">
      <span id="nowLabel">‚Äî</span>
      <select id="varSel"></select>
      <select id="scopeSel">
        <option value="filtered" selected>Intervalle</option>
        <option value="global">Globale</option>
      </select>
    </div>

    <div class="timeline">
      <div class="label" id="leftLabel">‚Äî</div>
      <div style="position:relative; flex:1;">
        <input id="range" type="range" min="0" max="0" step="1" value="0" />
        <div id="sliderTip"></div>
      </div>
      <div class="label" id="rightLabel">‚Äî</div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.36/dist.min.js"></script>

  <script>
    /* --- Styles de fond --- */
    const ESRI_SATELLITE_STYLE = {
      "version": 8,
      "sources": {
        "esri-world-imagery": {
          "type": "raster",
          "tiles": ["https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
          "tileSize": 256,
          "scheme": "xyz",
          "attribution": "¬© Esri, Maxar, Earthstar Geographics"
        }
      },
      "layers": [
        { "id": "background", "type": "background", "paint": { "background-color": "#000" } },
        { "id": "satellite", "type": "raster", "source": "esri-world-imagery" }
      ],
      "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf"
    };
    const STYLES = {
      Light: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
      Dark:  'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
      Satellite: ESRI_SATELLITE_STYLE
    };

    const $ = id => document.getElementById(id);
    const fmt = s => s ? s.replace('T',' ') : '‚Äî';

    /* --- MAP --- */
    const map = new maplibregl.Map({
      container: 'map',
      style: STYLES.Light,
      center: [10.401, 43.716], zoom: 12, hash: true
    });
    map.addControl(new maplibregl.NavigationControl({ showZoom:true, showCompass:true, visualizePitch:true }), 'top-right');

    /* --- S√©lecteur de styles --- */
    const styleCards = document.querySelectorAll('#styleButtons .style-card');
    function setActiveCard(name){
      styleCards.forEach(c=>{
        const on = c.dataset.style === name;
        c.classList.toggle('active', on);
        c.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    function applyStyle(name){
      const style = STYLES[name];
      if(!style) return;
      map.setStyle(style);
      map.once('style.load', async ()=>{ await refresh(); });
      setActiveCard(name);
    }
    styleCards.forEach(card=>{
      card.addEventListener('click', ()=> applyStyle(card.dataset.style));
    });
    setActiveCard('Light');

    /* --- Tooltip helpers --- */
    function showTooltipAt(info, html){
      const tipEl = $('tooltip');
      if(!info || !info.coordinate){ tipEl.style.display='none'; return; }
      tipEl.innerHTML = html; tipEl.style.display = 'block';
      tipEl.style.left = info.x + 'px'; tipEl.style.top  = info.y + 'px';
    }
    function hideTooltip(){ $('tooltip').style.display='none'; }
    function htmlRow(label, value){
      const v = (value===undefined || value===null || (Number.isFinite(value) && isNaN(value))) ? '‚Äî' : value;
      return `<div><span class="muted">${label}:</span> ${v}</div>`;
    }
    function tooltipHTML(info){
      if(!info || !info.object) return '';
      const id = info.layer && info.layer.id || '';
      const p  = info.object.properties || {};
      if(id === 'buildings'){ return `<h5>Building</h5>${htmlRow('PK', p.PK)}${htmlRow('Height', p.HEIGHT)}${htmlRow('Population', p.POP)}`; }
      if(id === 'traffic'){ return `<h5>Traffic</h5>${htmlRow('var', curVar)}${htmlRow('value', p[curVar])}${htmlRow('begin', p.begin)}${htmlRow('end', p.end)}${htmlRow('id', p.id)}`; }
      if(id === 'roads'){ return `<h5>Road</h5>${htmlRow('id', p.id)}`; }
      if(id === 'noise'){ return `<h5>Noise</h5>${htmlRow('PK', p.PK)}${htmlRow('begin', p.begin)}${htmlRow('end', p.end)}`; }
      return `<h5>Info</h5>${Object.entries(p).slice(0,6).map(([k,v])=>htmlRow(k,v)).join('')}`;
    }

    /* --- Deck.gl layers --- */
    let overlay=null;
    function roadsLayer(){ return new deck.GeoJsonLayer({
      id:'roads', data:'/api/map/roads', stroked:true,
      getLineColor:[135,206,235,220], getLineWidth:3,
      visible: $('chkRoads').checked && map.getZoom()>=10, pickable:true,
      onHover: info => info.object ? showTooltipAt(info, tooltipHTML(info)) : hideTooltip()
    });}
    function buildingsLayer(){ return new deck.GeoJsonLayer({
      id:'buildings', data:'/api/map/buildings', extruded:true,
      getElevation: f => Math.max(((typeof f.properties?.HEIGHT === 'number') ? f.properties.HEIGHT : 10) * 0.3, 2),
      getFillColor:[150,150,150,200], wireframe:false, pickable:true,
      visible: $('chkBuildings').checked,
      onHover: info => info.object ? showTooltipAt(info, tooltipHTML(info)) : hideTooltip()
    });}
    function noiseLayer(){ return new deck.GeoJsonLayer({
      id:'noise', data:'/api/map/noise', filled:true,
      getFillColor:[255,0,255,40], visible:$('chkNoise').checked, pickable:true,
      onHover: info => info.object ? showTooltipAt(info, tooltipHTML(info)) : hideTooltip()
    });}

    function colorRampRGBA(v,min,max){
      if(v==null||!isFinite(v)||min==null||max==null||max<=min) return [200,200,200,120];
      const t=Math.max(0,Math.min(1,(v-min)/(max-min+1e-9)));
      const r=t<.5?2*t*255:255, g=t<.5?255:(1-2*(t-.5))*255;
      return [Math.round(r),Math.round(g),0,220];
    }

    function drawColorbar(min, max){
      const cv=$('cbar'), ctx=cv.getContext('2d');
      cv.width=260; cv.height=12;
      const g=ctx.createLinearGradient(0,0,cv.width,0);
      g.addColorStop(0,'#00ff00'); g.addColorStop(.5,'#ffff00'); g.addColorStop(1,'#ff0000');
      ctx.clearRect(0,0,cv.width,cv.height);
      ctx.fillStyle=g; ctx.fillRect(0,0,cv.width,cv.height);

      const fmtFR = v => (v==null || !isFinite(v)) ? '‚Äî' : new Intl.NumberFormat('fr-FR',{maximumFractionDigits:2}).format(v);
      $('minLbl').innerHTML = `<span class="tag">min</span>${fmtFR(min)}`;
      $('maxLbl').innerHTML = `<span class="tag">max</span>${fmtFR(max)}`;
    }

    /* --- Data / API helpers --- */
    async function getVars(){ const r=await fetch('/api/map/traffic/vars'); if(!r.ok) return []; const j=await r.json(); return j.variables||[]; }
    async function getMinMax(variable,start,end,scope){
      const p=new URLSearchParams(); if(variable)p.set('var',variable); if(start)p.set('start',start); if(end)p.set('end',end); if(scope)p.set('scope',scope);
      const r=await fetch('/api/map/traffic/minmax?'+p.toString()); if(!r.ok) return {min:null,max:null}; return r.json();
    }
    async function getAllIntervals(){ const r=await fetch('/api/map/traffic/intervals'); if(!r.ok) return []; const j=await r.json(); return j.intervals||[]; }
    async function getBounds(){ const r=await fetch('/api/map/traffic/bounds'); if(!r.ok) return {min_begin:null,max_end:null}; return r.json(); }

    /* --- Trafic layer --- */
    let curVar='vehicles', curScope='filtered', curStart=null, curEnd=null, curMin=null, curMax=null;
    async function trafficLayer(){
      const st=await getMinMax(curVar,curStart,curEnd,curScope);
      curMin=st.min; curMax=st.max;
      drawColorbar(curMin, curMax);
      const p=new URLSearchParams(); p.set('var',curVar); if(curStart)p.set('start',curStart); if(curEnd)p.set('end',curEnd); p.set('scope',curScope);
      return new deck.GeoJsonLayer({
        id:'traffic', data:'/api/map/traffic?'+p.toString(),
        lineWidthUnits:'pixels', getLineWidth:3,
        getLineColor:f=>colorRampRGBA(f?.properties?.[curVar],curMin,curMax),
        visible:$('chkTraffic').checked && map.getZoom()>=12,
        pickable:true,
        onHover: info => info.object ? showTooltipAt(info, tooltipHTML(info)) : hideTooltip()
      });
    }

    /* --- Refresh overlay --- */
    async function refresh(){
      const layers=[ roadsLayer(), buildingsLayer(), noiseLayer(), await trafficLayer() ];
      if(!overlay){ overlay=new deck.MapboxOverlay({ interleaved:true, layers }); map.addControl(overlay); }
      else{ overlay.setProps({ layers }); }
      const visible = $('chkTraffic').checked || $('chkNoise').checked;
      $('player').classList.toggle('hidden', !visible);
    }

    /* --- Timeline / Player --- */
    let intervals=[], curIndex=0, playing=false, timer=null;
    function updateNowLabel(){ $('nowLabel').textContent = (curStart && curEnd) ? `${fmt(curStart)} ‚Üí ${fmt(curEnd)}` : '‚Äî'; }
    function syncFromIndex(){ const it=intervals[curIndex]; if(!it) return; curStart = it.begin ? it.begin.replace(' ','T') : null; curEnd = it.end ? it.end.replace(' ','T') : curStart; updateNowLabel(); }

    map.on('load', async ()=>{
      const vars=await getVars(); const vs=$('varSel');
      vs.innerHTML=''; (vars.length?vars:['vehicles','speed','speedRelative']).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; vs.appendChild(o); });
      curVar=vs.value;

      intervals=await getAllIntervals();
      const r=$('range'); r.min='0'; r.max=String(Math.max(0,intervals.length-1));

      const b = await getBounds();
      $('leftLabel').textContent  = fmt((b.min_begin || intervals[0]?.begin || '').replace('T',' '));
      $('rightLabel').textContent = fmt((b.max_end   || intervals.at(-1)?.end || '').replace('T',' '));

      /* üëâ d√©marrer √† DROITE (fin) : */
      curIndex = Math.max(0, intervals.length - 1);
      r.value  = String(curIndex);

      syncFromIndex();
      await refresh();
    });

    map.on('zoomend', refresh);

    ['chkBuildings','chkRoads','chkTraffic','chkNoise'].forEach(id=>{ $(id).addEventListener('change', ()=>{ refresh(); }); });
    $('varSel').addEventListener('change', async e=>{ curVar=e.target.value; await refresh(); });
    $('scopeSel').addEventListener('change', async e=>{ curScope=e.target.value; await refresh(); });

    $('btnPrev').onclick=async()=>{ if(!intervals.length) return; curIndex=Math.max(0,curIndex-1); $('range').value=String(curIndex); syncFromIndex(); await refresh(); };
    $('btnNext').onclick=async()=>{ if(!intervals.length) return; curIndex=Math.min(intervals.length-1,curIndex+1); $('range').value=String(curIndex); syncFromIndex(); await refresh(); };

    let currentIntervalMs = parseInt($('speedSel').value, 10) || 1800;
    $('speedSel').addEventListener('change', ()=>{ currentIntervalMs = parseInt($('speedSel').value, 10) || 1800;
      if(playing && timer){ clearInterval(timer);
        timer=setInterval(async ()=>{ if(!intervals.length) return; curIndex=Math.min(intervals.length-1,curIndex+1); $('range').value=String(curIndex); syncFromIndex(); await refresh();
          if(curIndex>=intervals.length-1){ playing=false; $('btnPlay').textContent='‚ñ∂'; clearInterval(timer); }
        }, currentIntervalMs);
      }
    });

    $('btnPlay').onclick=async()=>{ playing=!playing; $('btnPlay').textContent = playing ? '‚è∏' : '‚ñ∂';
      if(!playing){ if(timer) clearInterval(timer); await refresh(); return; }
      await refresh();
      timer=setInterval(async ()=>{ if(!intervals.length) return; curIndex=Math.min(intervals.length-1,curIndex+1); $('range').value=String(curIndex); syncFromIndex(); await refresh();
        if(curIndex>=intervals.length-1){ playing=false; $('btnPlay').textContent='‚ñ∂'; clearInterval(timer); }
      }, currentIntervalMs);
    };

    $('range').addEventListener('input', ()=>{ curIndex=Number($('range').value); syncFromIndex(); });
    $('range').addEventListener('change', async ()=>{ await refresh(); });
  </script>
</body>
</html>
